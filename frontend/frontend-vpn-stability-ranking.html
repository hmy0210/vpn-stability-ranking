<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPNå®‰å®šæ€§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€å®Ÿæ¸¬ãƒ‡ãƒ¼ã‚¿ã€‘</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2em;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        .region-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .region-btn {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .region-btn:hover {
            background: #f0f0f0;
        }
        .region-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .chart-wrapper {
            position: relative;
            min-height: 400px;
            margin-top: 20px;
        }
        .stability-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .stability-table th {
            background: #667eea;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }
        .stability-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #eee;
        }
        .stability-table th:nth-child(1),
        .stability-table td:nth-child(1) { width: 10%; text-align: center; }
        .stability-table th:nth-child(2),
        .stability-table td:nth-child(2) { width: 22%; }
        .stability-table th:nth-child(3),
        .stability-table td:nth-child(3) { width: 22%; }
        .stability-table th:nth-child(4),
        .stability-table td:nth-child(4) { width: 16%; text-align: right; }
        .stability-table th:nth-child(5),
        .stability-table td:nth-child(5) { width: 16%; text-align: right; }
        .stability-table th:nth-child(6),
        .stability-table td:nth-child(6) { width: 14%; text-align: right; }
        .stability-table tbody tr:hover {
            background: #f8f9fa;
        }
        .rank-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            font-weight: bold;
        }
        .rank-1 { background: #ffd700; color: #333; }
        .rank-2 { background: #c0c0c0; color: #333; }
        .rank-3 { background: #cd7f32; color: white; }
        .score-bar {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .score-value {
            font-weight: 600;
            color: #667eea;
            min-width: 40px;
        }
        .bar {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 1.5em; }
            .chart-container { padding: 20px; }
            .chart-wrapper { min-height: 300px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š VPNå®‰å®šæ€§ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1>
        <p class="subtitle">é€Ÿåº¦ã ã‘ã˜ã‚ƒãªã„ã€‚æœ¬å½“ã«ã€Œå®‰å®šã—ãŸã€VPNã¯ã©ã‚Œï¼Ÿ</p>
        
        <div class="region-selector">
            <button class="region-btn active" onclick="switchRegion('JP')">ğŸ‡¯ğŸ‡µ æ—¥æœ¬</button>
            <button class="region-btn" onclick="switchRegion('US')">ğŸ‡ºğŸ‡¸ ç±³å›½</button>
            <button class="region-btn" onclick="switchRegion('UK')">ğŸ‡¬ğŸ‡§ è‹±å›½</button>
            <button class="region-btn" onclick="switchRegion('SG')">ğŸ‡¸ğŸ‡¬ ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«</button>
        </div>
        
        <!-- å®‰å®šæ€§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="chart-container">
            <div class="chart-title">ğŸ“ˆ ç·åˆå®‰å®šæ€§ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆéå»30æ—¥ï¼‰</div>
            <div id="stabilityTable" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
        </div>
        
        <!-- ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ -->
        <div class="chart-container">
            <div class="chart-title">ğŸ¯ 5è»¸è©•ä¾¡ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆï¼ˆTOP3ï¼‰</div>
            <div class="chart-wrapper">
                <canvas id="radarChart"></canvas>
            </div>
        </div>
        
        <!-- æ™‚ç³»åˆ—æ¨ç§»ã‚°ãƒ©ãƒ• -->
        <div class="chart-container">
            <div class="chart-title">ğŸ“Š é€Ÿåº¦æ¨ç§»ï¼ˆéå»30æ—¥ï¼‰</div>
            <div class="chart-wrapper">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyAoHuuY0SNWlnqpmxipMIDZLOe55saUBhxri2a-aiBUgsLNDB-QB93xSLcU8fmlK7M/exec';
        let currentRegion = 'JP';
        let radarChartInstance = null;
        let trendChartInstance = null;
        
        function switchRegion(region) {
            currentRegion = region;
            
            document.querySelectorAll('.region-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadStabilityData(region);
        }
        
        async function loadStabilityData(region = 'JP') {
            try {
                // å®‰å®šæ€§ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—
                const stabilityResponse = await fetch(`${API_URL}?type=stability&region=${region}`);
                const stabilityData = await stabilityResponse.json();
                
                // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
                renderStabilityTable(stabilityData.data);
                
                // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿å–å¾—
                const radarResponse = await fetch(`${API_URL}?type=radar&region=${region}`);
                const radarData = await radarResponse.json();
                
                // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆæç”»
                renderRadarChart(radarData.data);
                
                // æ¨ç§»ã‚°ãƒ©ãƒ•æç”»ï¼ˆTOP3ã®ã¿ã€ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ï¼‰
                if (stabilityData.data.length >= 3 && stabilityData.data[0].dataPoints > 1) {
                    renderTrendChart(stabilityData.data.slice(0, 3), region);
                } else {
                    document.getElementById('trendChart').parentElement.innerHTML = 
                        '<div class="chart-title">ğŸ“Š é€Ÿåº¦æ¨ç§»ï¼ˆéå»30æ—¥ï¼‰</div>' +
                        '<div style="text-align: center; padding: 40px; color: #999;">ãƒ‡ãƒ¼ã‚¿ã‚’è“„ç©ä¸­ã§ã™ï¼ˆæ¸¬å®šãƒ‡ãƒ¼ã‚¿: ' + 
                        (stabilityData.data[0]?.dataPoints || 0) + 'ä»¶ï¼‰<br>24æ™‚é–“å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>';
                }
                
            } catch (error) {
                console.error('Error loading stability data:', error);
                document.getElementById('stabilityTable').innerHTML = 
                    '<div class="loading" style="color: #dc3545;">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }
        
        function renderStabilityTable(data) {
            let html = '<table class="stability-table">';
            html += '<thead><tr>';
            html += '<th>ãƒ©ãƒ³ã‚¯</th>';
            html += '<th>VPN</th>';
            html += '<th>å®‰å®šæ€§</th>';
            html += '<th>å¹³å‡é€Ÿåº¦</th>';
            html += '<th>ã°ã‚‰ã¤ã</th>';
            html += '<th>ä¿¡é ¼æ€§</th>';
            html += '</tr></thead>';
            html += '<tbody>';
            
            data.forEach((vpn, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                const rankIcon = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : rank;
                
                html += `<tr>`;
                html += `<td><span class="rank-badge ${rankClass}">${rankIcon}</span></td>`;
                html += `<td><strong>${vpn.name}</strong></td>`;
                html += `<td>
                    <div class="score-bar">
                        <span class="score-value">${vpn.stabilityScore}</span>
                        <div class="bar"><div class="bar-fill" style="width: ${vpn.stabilityScore}%"></div></div>
                    </div>
                </td>`;
                html += `<td>${vpn.avgSpeed} Mbps</td>`;
                html += `<td>Â±${vpn.speedStdDev} Mbps</td>`;
                html += `<td>${vpn.reliability}%</td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('stabilityTable').innerHTML = html;
        }
        
        function renderRadarChart(data) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            if (radarChartInstance) {
                radarChartInstance.destroy();
            }
            
            const datasets = data.slice(0, 3).map((vpn, index) => ({
                label: vpn.name,
                data: [
                    vpn.scores.speed,
                    vpn.scores.stability,
                    vpn.scores.regional,
                    vpn.scores.ping,
                    vpn.scores.reliability
                ],
                borderColor: getColor(index),
                backgroundColor: getColor(index, 0.15),
                borderWidth: 3,
                pointBackgroundColor: getColor(index),
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5
            }));
            
            radarChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['é€Ÿåº¦', 'å®‰å®šæ€§', 'åœ°åŸŸã‚«ãƒãƒ¼', 'Ping', 'ä¿¡é ¼æ€§'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            min: 0,
                            ticks: { 
                                stepSize: 20,
                                font: { size: 14 },
                                backdropColor: 'transparent'
                            },
                            pointLabels: {
                                font: { size: 16, weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            angleLines: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: {
                                font: { size: 16 },
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.r + '/100';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        async function renderTrendChart(topVPNs, region) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChartInstance) {
                trendChartInstance.destroy();
            }
            
            const datasets = [];
            
            for (let i = 0; i < Math.min(3, topVPNs.length); i++) {
                const vpn = topVPNs[i];
                
                try {
                    const trendResponse = await fetch(`${API_URL}?type=trend&vpn=${encodeURIComponent(vpn.name)}&region=${region}`);
                    const trendData = await trendResponse.json();
                    
                    if (trendData.data && trendData.data.length > 1) {
                        datasets.push({
                            label: vpn.name,
                            data: trendData.data.map(d => ({ x: d.date, y: d.speed })),
                            borderColor: getColor(i),
                            backgroundColor: getColor(i, 0.1),
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        });
                    }
                } catch (error) {
                    console.error(`Error loading trend for ${vpn.name}:`, error);
                }
            }
            
            if (datasets.length === 0) {
                document.getElementById('trendChart').parentElement.innerHTML = 
                    '<div class="chart-title">ğŸ“Š é€Ÿåº¦æ¨ç§»ï¼ˆéå»30æ—¥ï¼‰</div>' +
                    '<div style="text-align: center; padding: 40px; color: #999;">ãƒ‡ãƒ¼ã‚¿ã‚’è“„ç©ä¸­ã§ã™<br>24æ™‚é–“å¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>';
                return;
            }
            
            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: { 
                            type: 'time',
                            time: { 
                                unit: 'day',
                                displayFormats: { day: 'MM/DD' }
                            },
                            title: { 
                                display: true, 
                                text: 'æ—¥ä»˜',
                                font: { size: 14 }
                            }
                        },
                        y: { 
                            beginAtZero: false,
                            title: { 
                                display: true, 
                                text: 'é€Ÿåº¦ (Mbps)',
                                font: { size: 14 }
                            },
                            ticks: { 
                                stepSize: 50,
                                font: { size: 12 }
                            }
                        }
                    },
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: {
                                font: { size: 16 },
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + Math.round(context.parsed.y) + ' Mbps';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function getColor(index, alpha = 1) {
            const colors = [
                `rgba(102, 126, 234, ${alpha})`,
                `rgba(118, 75, 162, ${alpha})`,
                `rgba(237, 100, 166, ${alpha})`,
                `rgba(255, 154, 158, ${alpha})`,
                `rgba(250, 208, 196, ${alpha})`
            ];
            return colors[index % colors.length];
        }
        
        // åˆå›ãƒ­ãƒ¼ãƒ‰
        loadStabilityData('JP');
    </script>
</body>
</html>
